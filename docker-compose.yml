version: '3.3'

services:
  # PostgreSQL Database (Local Development)
  postgres:
    image: postgres:15-alpine
    container_name: smartflow_postgres
    restart: always
    ports:
      - "5433:5432"
    environment:
      - POSTGRES_USER=smartflow
      - POSTGRES_PASSWORD=smartflow123
      - POSTGRES_DB=smartflow
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - smartflow_net

  evolution-api:
    image: atendai/evolution-api:v1.8.2
    container_name: evolution_api
    restart: always
    ports:
      - "8081:8080"
    environment:
      - SERVER_PORT=8080
      - AUTHENTICATION_API_KEY=${AUTHENTICATION_API_KEY}
      - AUTHENTICATION_EXPOSE_IN_FETCH_INSTANCES=true

      # Store Configuration (For v1.x - uses file/Redis based storage)
      - STORE_MESSAGES=true
      - STORE_MESSAGE_UP=true
      - STORE_CONTACTS=true
      - STORE_CHATS=true

      # Redis Configuration
      - REDIS_ENABLED=true
      - REDIS_URI=redis://redis:6379
      - CACHE_REDIS_ENABLED=true
      - CACHE_REDIS_URI=redis://redis:6379

      # SAFETY & RATE LIMITING CONFIGURATION
      - DEL_INSTANCE=false
      - QRCODE_LIMIT=30

      # Webhook (Global - can be overridden per instance)
      - WEBHOOK_GLOBAL_ENABLED=false

      # Logging
      - LOG_LEVEL=ERROR
      - LOG_BAILEYS=error

    volumes:
      - evolution_instances:/evolution/instances
      - evolution_store:/evolution/store
    networks:
      - smartflow_net
    depends_on:
      - redis

  redis:
    image: redis:alpine
    container_name: evolution_redis
    restart: always
    command: redis-server --appendonly yes
    volumes:
      - redis_data:/data
    networks:
      - smartflow_net

volumes:
  postgres_data:
  evolution_instances:
  evolution_store:
  redis_data:


networks:
  smartflow_net:
